<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Interactive Itinerary ‚Äî Japan + Hong Kong (UX Friendly)</title>

<!-- Meta: discoverability & theming -->
<meta name="description" content="An interactive, UX-friendly travel itinerary for Japan and Hong Kong with filters, progress tracking, dark mode, and import/export.">
<meta name="robots" content="index,follow">
<meta name="color-scheme" content="light dark">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#F5F5F4">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b1220">

<!-- Open Graph / Twitter for rich link previews -->
<meta property="og:title" content="Interactive Itinerary ‚Äî Japan + Hong Kong">
<meta property="og:description" content="Check off activities, filter by city/tag, and export/import progress.">
<meta property="og:type" content="website">
<meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'%3E%3Crect fill='%23F5F5F4' width='100%25' height='100%25'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Inter,Arial' font-size='48' fill='%2344403C'%3EInteractive Itinerary%3C/text%3E%3C/svg%3E">
<meta name="twitter:card" content="summary_large_image">

<!-- Tailwind CDN (kept as in original) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<!-- Favicon (small data-URI, no extra files needed) -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='52' x='6' font-size='52'%3E%F0%9F%97%BA%EF%B8%8F%3C/text%3E%3C/svg%3E">

<!-- Chosen Palette: Warm Neutrals -->
<!-- Application Structure Plan... -->
<!-- Visualization & Content Choices... -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<style>
  :root { color-scheme: light dark; }
  html.dark body { background: #0b1220; color: #e5e7eb; }
  body { font-family: 'Inter', sans-serif; background-color: #F5F5F4; /* stone-100 */ color: #44403C; /* stone-700 */ }
  .card { border:1px solid rgb(226,232,240); border-radius: 14px; background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
  .dark .card { border-color: rgb(30,41,59); background: rgb(15,23,42); }
  .badge { border-radius: 9999px; padding: 2px 8px; font-size: 12px; }
  .badge-black { background:#000; color:#fff; }
  .tab-btn { border:1px solid transparent; padding: 6px 10px; border-radius: 10px; transition: background-color 0.2s, color 0.2s; }
  .tab-btn.active { background: #A8A29E; /* stone-400 */ color: white; font-weight: 600; }
  .dark .tab-btn.active { background: #57534E; /* stone-600 */ }
  .progress { height: 8px; background: rgb(226,232,240); border-radius: 9999px; overflow: hidden; }
  .dark .progress { background: rgb(30,41,59); }
  .progress > span { display:block; height:100%; background: linear-gradient(90deg, #22c55e, #06b6d4); }
  .btn { border:1px solid rgb(203,213,225); border-radius: 10px; padding:6px 10px; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
  .dark .btn { border-color: rgb(51,65,85); }
  .btn-primary { background: #57534E; /* stone-600 */ color:white; border-color:#57534E; }
  .btn-primary:hover { background: #44403C; /* stone-700 */ border-color:#44403C; }
  .btn-danger { background: #EF4444; /* red-500 */ color:white; border-color:#EF4444; }
  .btn-danger:hover { background: #DC2626; /* red-600 */ border-color:#DC2626; }
  .pill { border:1px solid rgb(203,213,225); border-radius:9999px; padding:2px 8px; font-size:12px; }
  .dark .pill { border-color: rgb(51,65,85); }
  .strike { text-decoration: line-through; opacity:.6; }

  /* New UX styles */
  .main-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
  @media (min-width: 1024px) { /* lg breakpoint */
    .main-grid { grid-template-columns: 200px 1fr; } /* Sidebar width + content */
    .content-area { padding-left: 1.5rem; } /* Offset for fixed sidebar */
  }

  .sidebar {
    position: sticky;
    top: 5rem; /* Below header */
    height: calc(100vh - 6rem); /* Adjust based on header height */
    overflow-y: auto;
    padding-right: 1rem;
    scrollbar-width: thin;
    scrollbar-color: #A8A29E #F5F5F4;
  }
  .sidebar a {
    display: block;
    padding: 0.5rem 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 0.5rem;
    color: #57534E; /* stone-600 */
    transition: background-color 0.2s, color 0.2s;
  }
  .sidebar a:hover, .sidebar a.active {
    background-color: #E7E5E4; /* stone-200 */
    color: #292524; /* stone-800 */
    font-weight: 600;
  }
  .dark .sidebar a { color: #A8A29E; }
  .dark .sidebar a:hover, .dark .sidebar a.active { background-color: #3F3F46; /* neutral-700 */ color: #F5F5F4; }

  .section-heading {
    font-size: 2.25rem; /* text-4xl */
    font-weight: 900; /* font-black */
    color: #292524; /* stone-800 */
    margin-bottom: 2rem;
    padding-top: 1rem; /* Space for sticky header */
    border-bottom: 2px solid #D6D3D1; /* stone-300 */
    padding-bottom: 0.5rem;
    margin-top: 3rem;
  }

  .path-details {
    border-left: 3px solid #D6D3D1; /* stone-300 */
    padding-left: 1rem;
    margin-top: 1rem;
    text-align: left;
    background-color: #F8F7F6; /* very light neutral */
    border-radius: 0.5rem;
    padding: 1rem;
    transition: all 0.3s ease-in-out;
    opacity: 1;
  }
  .dark .path-details {
    background-color: #1E293B; /* slate-800 */
    border-color: #334155; /* slate-700 */
  }
  .path-details.hidden {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    padding-top: 0;
    padding-bottom: 0;
    margin-top: 0;
    margin-bottom: 0;
  }

  details summary {
    cursor: pointer;
    font-weight: 600;
    padding: 0.5rem 0;
    color: #57534E; /* stone-600 */
    transition: color 0.2s;
  }
  details summary:hover { color: #292524; /* stone-800 */ }
  details[open] summary { color: #292524; /* stone-800 */ }
  details > div {
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }
  details:not([open]) > div { max-height: 0; } /* Managed by JS for smooth transition */

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }
  .modal-overlay.open { opacity: 1; visibility: visible; }
  .modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    max-width: 400px;
    width: 90%;
    transform: translateY(-20px);
    transition: transform 0.3s ease-out;
  }
  .modal-overlay.open .modal-content { transform: translateY(0); }
  .dark .modal-content { background-color: #1A202C; /* dark bg */ color: #E2E8F0; }
</style>
</head>
<body class="min-h-screen">
  <div class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-900/80 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-2">
      <span class="text-xl font-bold text-stone-800 dark:text-stone-100">üó∫Ô∏è Interactive Itinerary ‚Äî Japan + Hong Kong</span>
      <div class="ml-auto flex items-center gap-2">
        <button id="printBtn" class="btn">üñ®Ô∏è Print</button>
        <button id="exportBtn" class="btn">‚¨áÔ∏è Export</button>
        <label class="btn cursor-pointer">‚¨ÜÔ∏è Import
          <input id="importInput" type="file" accept="application/json" class="hidden">
        </label>
        <button id="resetBtn" class="btn btn-danger">‚Ü∫ Reset</button>
        <label class="flex items-center gap-2 pl-2" aria-label="Toggle dark mode">
          <span>üåû</span>
          <input id="darkToggle" type="checkbox" class="accent-blue-500">
          <span>üåô</span>
        </label>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-4 main-grid">
    <!-- Sidebar / Table of Contents -->
    <div class="hidden lg:block sidebar" aria-label="Table of contents">
      <nav id="sidebarNav">
        <h3 class="font-bold text-stone-800 text-lg mb-2">Sections</h3>
        <!-- Content populated by JS -->
      </nav>
    </div>

    <!-- Main Content Area -->
    <div class="content-area lg:col-start-2">
      <div class="card p-4 mb-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <div class="text-xs mb-1 text-slate-500">City</div>
            <select id="cityFilter" class="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900" aria-label="Filter by city"></select>
          </div>
          <div>
            <div class="text-xs mb-1 text-slate-500">Tag</div>
            <select id="tagFilter" class="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900" aria-label="Filter by tag"></select>
          </div>
          <div>
            <div class="text-xs mb-1 text-slate-500">Status</div>
            <select id="statusFilter" class="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900" aria-label="Filter by status">
              <option>All</option>
              <option>Todo</option>
              <option>Done</option>
            </select>
          </div>
          <div>
            <div class="text-xs mb-1 text-slate-500">Search</div>
            <div class="relative">
              <input id="searchInput" class="w-full rounded-xl border px-3 py-2" placeholder="Find activities‚Ä¶" aria-label="Search activities">
              <div class="absolute right-2 top-2 text-slate-400" aria-hidden="true">üîé</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card p-4 mb-8">
        <div class="text-base font-semibold mb-2">Progress</div>
        <div id="progressSummary" class="space-y-2"></div>
      </div>

      <div id="nextUpWrap" class="max-w-6xl mx-auto px-0"></div>

      <!-- Content sections for itinerary and practical info -->
      <div id="itineraryContent" class="pb-16"></div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 pb-16 text-xs text-slate-500 text-center">
    Built with ‚ù§Ô∏è ‚Äî tick off what you‚Äôve done, filter by city/tag, Export/Import to sync across devices. Print anytime.
  </div>

  <!-- Noscript notice -->
  <noscript>
    <div style="max-width: 48rem; margin: 1rem auto; padding: 1rem; border: 1px solid #D6D3D1; background: #fff; border-radius: 0.5rem; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
      This page needs JavaScript enabled to work properly (filters, progress, and tabs).
    </div>
  </noscript>

  <!-- Custom Modal HTML -->
  <div id="customModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalMessage">
    <div class="modal-content">
      <h3 id="modalTitle" class="text-lg font-bold mb-4"></h3>
      <p id="modalMessage" class="text-sm text-stone-600 dark:text-stone-300 mb-6"></p>
      <div class="flex justify-end gap-3">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalConfirm" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = "itinerary-progress-v2-standalone";

const itineraryData = {
    preTripEssentials: {
        id: "pre-trip",
        title: "Pre-Trip Essentials: Preparing for Your Seamless Expedition",
        sections: [
            { heading: "Navigating Japan: The Veins of the Nation", content: `Japan's public transportation system is globally acclaimed for its efficiency, punctuality, and extensive network, making travel across the country remarkably convenient. The Shinkansen (Bullet Train) is the quintessential mode of inter-city travel, connecting major hubs like Tokyo, Kyoto, and Osaka with unparalleled speed and comfort. For optimal planning, online reservation is highly recommended. Local train and subway systems are user-friendly, with color-coded lines. IC Cards (SUICA/ICOCA) are indispensable prepaid cards for cash-free travel and payments. Luggage delivery services like LUGGAGE EXPRESS are highly advantageous for groups traveling between cities, freeing you from carrying heavy bags.`, details: `<p class="text-sm text-stone-500 mt-2"><strong>Shinkansen Tips:</strong> Online reservation allows free changes. An additional "NOZOMI MIZUHO Ticket" is required for the fastest Nozomi trains. Evaluate JR Pass cost-effectiveness carefully.</p><p class="text-sm text-stone-500 mt-1"><strong>Local Trains:</strong> Avoid peak rush hours (8-9 AM, after 5 PM). Color-coded lines simplify navigation.</p><p class="text-sm text-stone-500 mt-1"><strong>IC Cards:</strong> SUICA for Tokyo (downloadable to Apple Wallet), ICOCA for Kansai (Kyoto, Osaka, Nara). Accepted for transport and payments at stores.</p><p class="text-sm text-stone-500 mt-1"><strong>Luggage Delivery:</strong> LUGGAGE EXPRESS can transport luggage from Tokyo to Kyoto hotel on the same day via Shinkansen, turning travel days into sightseeing opportunities.</p>` },
            { heading: "Navigating Hong Kong: Urban Efficiency", content: `Hong Kong's compact geography and advanced infrastructure ensure highly efficient urban transit. The MTR (Mass Transit Railway) is the backbone of its urban transport. The Octopus Card is an essential contactless smart card for all transport and payments. Double-decker buses offer great views, and taxis are reliable (cash only).`, details: `<p class="text-sm text-stone-500 mt-2"><strong>MTR:</strong> Provides quick and efficient connections across all major districts.</p><p class="text-sm text-stone-500 mt-1"><strong>Octopus Card:</strong> Available as physical Tourist Octopus or Mobile Octopus. Widely accepted for transport, dining, entertainment, and shopping.</p><p class="text-sm text-stone-500 mt-1"><strong>Buses & Taxis:</strong> Double-decker buses offer elevated views. Taxis are metered and trustworthy (cash payments primarily).</p><p class="text-sm text-stone-500 mt-1"><strong>HKeMobility:</strong> Useful mobile application for planning journeys across all public transport modes.</p>` },
            { heading: "Connectivity & Cash: Staying Connected and Prepared", content: `Reliable internet access is paramount. Consider portable Wi-Fi devices or local eSIMs. Both Japan and Hong Kong still operate significantly on cash, especially for smaller establishments. Carry sufficient Japanese Yen and Hong Kong Dollars.`, details: `` },
            { heading: "Cultural Compass: Respectful Immersion", content: `Engaging respectfully with local customs enhances the travel experience. Observe train etiquette (avoid loud conversations, respect priority seating). Learning basic phrases in Japanese and Cantonese can enrich interactions.`, details: `<p class="text-sm text-stone-500 mt-2"><strong>Japanese Phrases:</strong> <em>arigato</em> (thank you), <em>sumimasen</em> (excuse me).</p><p class="text-sm text-stone-500 mt-1"><strong>Cantonese Phrases:</strong> <em>jo san</em> (good morning), <em>m goi</em> (thank you/excuse me).</p>` },
            { heading: "Autumn's Embrace: Weather, Festivals & Public Holidays (September - October 2025)", content: `The travel period offers pleasant autumn weather but be mindful of potential typhoons in early September. This period is vibrant with festivals and public holidays, which can lead to increased domestic tourism and crowds. Proactive booking and flexible planning are essential.`, details: `<div class="overflow-x-auto mt-4"><table class="min-w-full bg-white border border-stone-300 rounded-lg"><thead><tr class="bg-stone-100 text-stone-700"><th class="py-2 px-4 border-b text-left text-sm font-semibold">Date</th><th class="py-2 px-4 border-b text-left text-sm font-semibold">Holiday/Festival Name</th><th class="py-2 px-4 border-b text-left text-sm font-semibold">Location</th><th class="py-2 px-4 border-b text-left text-sm font-semibold">Brief Description</th><th class="py-2 px-4 border-b text-left text-sm font-semibold">Impact on Travel</th></tr></thead><tbody><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep 13-14</td><td class="py-2 px-4 text-sm">ULTRA JAPAN</td><td class="py-2 px-4 text-sm">Tokyo Odaiba Ultra Park</td><td class="py-2 px-4 text-sm">Electronic music festival</td><td class="py-2 px-4 text-sm">Potential for large crowds, especially youth</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep 14-15</td><td class="py-2 px-4 text-sm">Kishiwada Danjiri Matsuri</td><td class="py-2 px-4 text-sm">Kishiwada City, Osaka</td><td class="py-2 px-4 text-sm">Energetic festival with large wooden floats</td><td class="py-2 px-4 text-sm">Expect significant local crowds in Kishiwada</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep 15</td><td class="py-2 px-4 text-sm">Respect for the Aged Day</td><td class="py-2 px-4 text-sm">National Holiday</td><td class="py-2 px-4 text-sm">Day to respect elderly, celebrate long life</td><td class="py-2 px-4 text-sm">National Holiday - Expect crowds at popular sites & on transport</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep 15-29</td><td class="py-2 px-4 text-sm">Tokyo Festival</td><td class="py-2 px-4 text-sm">Ikebukuro, Tokyo</td><td class="py-2 px-4 text-sm">International performing arts festival</td><td class="py-2 px-4 text-sm">Cultural events, potential for localized crowds</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Mid-Sep</td><td class="py-2 px-4 text-sm">Nezu-jinja Shrine Annual Grand Festival</td><td class="py-2 px-4 text-sm">Nezu Shrine, Tokyo</td><td class="py-2 px-4 text-sm">Lively affair with stalls, traditional dance</td><td class="py-2 px-4 text-sm">Localized crowds, cultural experience</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep 21</td><td class="py-2 px-4 text-sm">Chofu Autumn Fireworks</td><td class="py-2 px-4 text-sm">Banks of Tama River, Chofu, Tokyo</td><td class="py-2 px-4 text-sm">Music and fireworks display</td><td class="py-2 px-4 text-sm">Large crowds along the river</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep 23</td><td class="py-2 px-4 text-sm">Autumnal Equinox Day</td><td class="py-2 px-4 text-sm">National Holiday</td><td class="py-2 px-4 text-sm">Day to honor and remember ancestors</td><td class="py-2 px-4 text-sm">National Holiday - Expect crowds at popular sites & on transport</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep-Oct</td><td class="py-2 px-4 text-sm">Cosmos Festival</td><td class="py-2 px-4 text-sm">Showa Kinen Park, Tokyo</td><td class="py-2 px-4 text-sm">Fields of cosmos flowers in bloom</td><td class="py-2 px-4 text-sm">Popular for flower viewing, expect visitors</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep-Oct</td><td class="py-2 px-4 text-sm">Red Spider Lily Festival</td><td class="py-2 px-4 text-sm">Kinchakuda, Saitama</td><td class="py-2 px-4 text-sm">Five million blood-red flowers in bloom</td><td class="py-2 px-4 text-sm">Popular for flower viewing, expect visitors</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Sep-Nov</td><td class="py-2 px-4 text-sm">USJ Halloween</td><td class="py-2 px-4 text-sm">Universal Studios Japan, Osaka</td><td class="py-2 px-4 text-sm">Park transforms into Halloween party with themed food</td><td class="py-2 px-4 text-sm">High attendance, especially weekends</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Oct 1</td><td class="py-2 px-4 text-sm">Citizens Day</td><td class="py-2 px-4 text-sm">Tokyo</td><td class="py-2 px-4 text-sm">Many Tokyo government facilities offer free admission</td><td class="py-2 px-4 text-sm">Increased visitors to participating facilities</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Early Oct</td><td class="py-2 px-4 text-sm">Fukuro Matsuri</td><td class="py-2 px-4 text-sm">Ikebukuro, Tokyo</td><td class="py-2 px-4 text-sm">Mikoshi parade, music, dance performances</td><td class="py-2 px-4 text-sm">Localized crowds, vibrant street atmosphere</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Oct 13</td><td class="py-2 px-4 text-sm">Sports Day</td><td class="py-2 px-4 text-sm">National Holiday</td><td class="py-2 px-4 text-sm">Day to enjoy physical activity, focus on health</td><td class="py-2 px-4 text-sm">National Holiday - Expect crowds at popular sites & on transport</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Oct 13</td><td class="py-2 px-4 text-sm">Bakeneko Festival</td><td class="py-2 px-4 text-sm">Tokyo</td><td class="py-2 px-4 text-sm">Unique cat-themed festival</td><td class="py-2 px-4 text-sm">Niche event, potential for quirky cultural experience</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Oct 14</td><td class="py-2 px-4 text-sm">Kawagoe Festival</td><td class="py-2 px-4 text-sm">Kawagoe, Saitama</td><td class="py-2 px-4 text-sm">Traditional festival in "Little Edo"</td><td class="py-2 px-4 text-sm">Localized crowds, cultural immersion</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Oct 22</td><td class="py-2 px-4 text-sm">Jidai Matsuri</td><td class="py-2 px-4 text-sm">Kyoto</td><td class="py-2 px-4 text-sm">Historical parade</td><td class="py-2 px-4 text-sm">Significant crowds along parade route</td></tr><tr class="border-b border-stone-200"><td class="py-2 px-4 text-sm">Oct 22</td><td class="py-2 px-4 text-sm">Kurama Fire Festival</td><td class="py-2 px-4 text-sm">Kurama, Kyoto</td><td class="py-2 px-4 text-sm">Traditional fire festival</td><td class="py-2 px-4 text-sm">Significant localized crowds, unique experience</td></tr></tbody></table></div>` }
        ]
    },
    itineraryDays: [
        {"date": "2025-09-27", "city": "Tokyo", "canon": "Canon: be in Tokyo", "paths": [{"id": "A", "name": "Shibuya/Harajuku + view", "slots": {"Morning": [{"id": "0927A-M1", "title": "Arrive & drop bags", "tags": ["logistics"]}, {"id": "0927A-M2", "title": "Coffee at depachika", "tags": ["food", "market"]}], "Afternoon": [{"id": "0927A-P1", "title": "Meiji Jingu Shrine", "tags": ["shrine", "culture", "calm"]}, {"id": "0927A-P2", "title": "Harajuku (Takeshita)", "tags": ["shopping", "street"]}], "Evening": [{"id": "0927A-E1", "title": "Shibuya Sky sunset", "tags": ["view", "rooftop"]}, {"id": "0927A-E2", "title": "Cocktails @ The Roof SHIBUYA SKY", "tags": ["rooftop", "bar"]}]}}, {"id": "B", "name": "Asakusa + Skytree", "slots": {"Morning": [{"id": "0927B-M1", "title": "Senso-ji & Nakamise", "tags": ["temple", "streetfood"]}], "Afternoon": [{"id": "0927B-P1", "title": "Tokyo Skytree", "tags": ["view"]}, {"id": "0927B-P2", "title": "Solamachi bites", "tags": ["food", "mall"]}], "Evening": [{"id": "0927B-E1", "title": "Omoide Yokocho yakitori", "tags": ["izakaya", "food"]}, {"id": "0927B-E2", "title": "Golden Gai microbars", "tags": ["nightlife"]}]}}, {"id": "C", "name": "Roppongi art + skyline bar", "slots": {"Morning": [{"id": "0927C-M1", "title": "Late brunch settle-in", "tags": ["food"]}], "Afternoon": [{"id": "0927C-P1", "title": "Mori Art Museum / stroll", "tags": ["art"]}], "Evening": [{"id": "0927C-E1", "title": "Andaz Tokyo Rooftop Bar", "tags": ["rooftop", "bar"]}]}}]},
        {"date": "2025-09-28", "city": "Tokyo", "canon": "Updated: Sumo finals - requires advance tickets", "paths": [{"id": "A", "name": "Sumo Finals & Ryogoku", "slots": {"Morning": [{"id": "0928A-M1", "title": "Explore Ryogoku district", "tags": ["culture"]}, {"id": "0928A-M2", "title": "Sumo Museum", "tags": ["museum", "sumo"]}], "Afternoon": [{"id": "0928A-P1", "title": "Attend Sumo Grand Tournament Finals", "tags": ["sumo", "event", "requires booking"]}], "Evening": [{"id": "0928A-E1", "title": "Chanko Nabe dinner (sumo stew)", "tags": ["food", "sumo"]}, {"id": "0928A-E2", "title": "Rooftop: The Roof @ Shibuya Stream", "tags": ["rooftop", "bar"]}]}}, {"id": "B", "name": "NPB baseball @ Meiji Jingu", "slots": {"Morning": [{"id": "0928B-M1", "title": "Caf√© crawl (Omotesando)", "tags": ["coffee", "food"]}, {"id": "0928B-M2", "title": "Meiji Jingu Shrine walk", "tags": ["shrine", "calm"]}], "Afternoon": [{"id": "0928B-P1", "title": "Omotesando window-shopping", "tags": ["shopping"]}], "Evening": [{"id": "0928B-E1", "title": "Yakult Swallows game at Meiji Jingu Stadium", "tags": ["sports", "night"]}]}}, {"id": "C", "name": "teamLab + skyline", "slots": {"Morning": [{"id": "0928C-M1", "title": "Toyosu brunch", "tags": ["food"]}], "Afternoon": [{"id": "0928C-P1", "title": "teamLab Planets", "tags": ["art", "immersive"]}], "Evening": [{"id": "0928C-E1", "title": "Shibuya Sky or Andaz Rooftop", "tags": ["rooftop", "bar", "view"]}]}}, {"id": "D", "name": "Kabukiza single‚Äëact + Ginza", "slots": {"Morning": [{"id": "0928D-M1", "title": "Ginza flagship stroll", "tags": ["shopping"]}], "Afternoon": [{"id": "0928D-P1", "title": "Queue for Kabukiza single‚Äëact (makumi)", "tags": ["theatre", "culture"]}], "Evening": [{"id": "0928D-E1", "title": "Sushi or tempura dinner", "tags": ["food"]}]}}]},
        {"date": "2025-09-29", "city": "Tokyo", "paths": [{"id": "A", "name": "Kamakura day trip", "slots": {"Morning": [{"id": "0929A-M1", "title": "JR to Kamakura (~1h)", "tags": ["train", "daytrip"]}, {"id": "0929A-M2", "title": "Great Buddha (Kotoku‚Äëin)", "tags": ["temple", "iconic"]}], "Afternoon": [{"id": "0929A-P1", "title": "Hase‚Äëdera temple & views", "tags": ["temple", "view"]}, {"id": "0929A-P2", "title": "Komachi‚Äëdori snack crawl", "tags": ["streetfood"]}], "Evening": [{"id": "0929A-E1", "title": "Return to Tokyo; ramen run", "tags": ["food"]}]}}, {"id": "B", "name": "Pop culture + Planets", "slots": {"Morning": [{"id": "0929B-M1", "title": "Akihabara arcades & retro", "tags": ["games", "pop"]}], "Afternoon": [{"id": "0929B-P1", "title": "teamLab Planets (if not yet)", "tags": ["immersive"]}], "Evening": [{"id": "0929B-E1", "title": "Wagyu yakiniku dinner", "tags": ["food"]}]}}, {"id": "C", "name": "Old Tokyo lanes", "slots": {"Morning": [{"id": "0929C-M1", "title": "Yanaka Ginza retro", "tags": ["street", "neighbourhood"]}], "Afternoon": [{"id": "0929C-P1", "title": "Kappabashi (kitchen street)", "tags": ["shopping"]}, {"id": "0929C-P2", "title": "Kuramae coffee", "tags": ["coffee"]}], "Evening": [{"id": "0929C-E1", "title": "Ginza cocktails", "tags": ["bar"]}]}}]},
        {"date": "2025-09-30", "city": "Tokyo", "paths": [{"id": "A", "name": "Tsukiji + knives", "slots": {"Morning": [{"id": "0930A-M1", "title": "Tsukiji sushi breakfast", "tags": ["market", "food"]}], "Afternoon": [{"id": "0930A-P1", "title": "Knife demos/shopping", "tags": ["shopping", "craft"]}, {"id": "0930A-P2", "title": "Depachika safari", "tags": ["foodhall"]}], "Evening": [{"id": "0930A-E1", "title": "Rooftop: Andaz or Levita", "tags": ["rooftop", "bar"]}]}}, {"id": "B", "name": "Seasonal gardens", "slots": {"Morning": [{"id": "0930B-M1", "title": "Showa Kinen Park (cosmos)", "tags": ["garden", "flowers"]}], "Afternoon": [{"id": "0930B-P1", "title": "Rikugien or Koishikawa Korakuen", "tags": ["garden"]}], "Evening": [{"id": "0930B-E1", "title": "Golden Gai bar-hop", "tags": ["nightlife"]}]}}, {"id": "C", "name": "Architecture day", "slots": {"Morning": [{"id": "0930C-M1", "title": "Daikanyama & Nakameguro", "tags": ["neighbourhood"]}], "Afternoon": [{"id": "0930C-P1", "title": "Omotesando architecture walk", "tags": ["design"]}], "Evening": [{"id": "0930C-E1", "title": "Omakase dinner (booked)", "tags": ["food", "omakase"]}]}}]},
        {"date": "2025-10-01", "city": "Kyoto", "canon": "Canon transfer: Tokyo ‚Üí Kyoto", "paths": [{"id": "A", "name": "Standard move", "slots": {"Morning": [{"id": "1001A-M1", "title": "Leisurely breakfast; last Tokyo errand", "tags": ["logistics"]}], "Afternoon": [{"id": "1001A-P1", "title": "Shinkansen (~2h20m)", "tags": ["train"]}, {"id": "1001A-P2", "title": "Check-in; Nishiki Market graze", "tags": ["market", "food"]}], "Evening": [{"id": "1001A-E1", "title": "Pontoch≈ç alley dinner", "tags": ["food", "alley"]}]}}]},
        {"date": "2025-10-02", "city": "Kyoto", "paths": [{"id": "A", "name": "Arashiyama early", "slots": {"Morning": [{"id": "1002A-M1", "title": "Bamboo Grove at opening", "tags": ["scenic"]}, {"id": "1002A-M2", "title": "Tenryu-ji garden", "tags": ["temple", "garden"]}], "Afternoon": [{"id": "1002A-P1", "title": "Otagi Nenbutsu-ji", "tags": ["temple", "quirky"]}], "Evening": [{"id": "1002A-E1", "title": "Tea ceremony ‚Üí Kaiseki dinner", "tags": ["tea", "kaiseki"]}]}}, {"id": "B", "name": "Fushimi + sake", "slots": {"Morning": [{"id": "1002B-M1", "title": "Fushimi Inari (early)", "tags": ["shrine", "hike"]}], "Afternoon": [{"id": "1002B-P1", "title": "Fushimi sake tastings", "tags": ["sake", "tasting"]}], "Evening": [{"id": "1002B-E1", "title": "Obanzai bistro", "tags": ["food"]}]}}, {"id": "C", "name": "Uji matcha day", "slots": {"Morning": [{"id": "1002C-M1", "title": "JR to Uji (20‚Äì30m)", "tags": ["train", "daytrip"]}, {"id": "1002C-M2", "title": "Byodoin Phoenix Hall", "tags": ["temple", "UNESCO"]}], "Afternoon": [{"id": "1002C-P1", "title": "Tea tasting; Uji River stroll", "tags": ["tea", "walk"]}], "Evening": [{"id": "1002C-E1", "title": "Back to Kyoto; Kiyamachi izakaya", "tags": ["izakaya"]}]}}]},
        {"date": "2025-10-03", "city": "Kyoto", "canon": "Canon transfer: Kyoto ‚Üí Osaka", "paths": [{"id": "A", "name": "Classic handoff", "slots": {"Morning": [{"id": "1003A-M1", "title": "Kiyomizu-dera + Higashiyama (early)", "tags": ["temple", "view"]}], "Afternoon": [{"id": "1003A-P1", "title": "Shinkansen to Osaka (13‚Äì15m)", "tags": ["train"]}, {"id": "1003A-P2", "title": "Namba check-in", "tags": ["logistics"]}], "Evening": [{"id": "1003A-E1", "title": "Dotonbori street-food crawl", "tags": ["streetfood"]}]}}, {"id": "B", "name": "Himeji today", "slots": {"Morning": [{"id": "1003B-M1", "title": "Shinkansen to Himeji; castle", "tags": ["castle", "UNESCO"]}], "Afternoon": [{"id": "1003B-P1", "title": "Koko-en garden", "tags": ["garden"]}, {"id": "1003B-P2", "title": "Continue to Osaka & settle in", "tags": ["train", "logistics"]}], "Evening": [{"id": "1003B-E1", "title": "Neon Dotonbori", "tags": ["nightlife"]}]}}, {"id": "C", "name": "Slow morning", "slots": {"Morning": [{"id": "1003C-M1", "title": "Nijo Castle stroll", "tags": ["castle"]}], "Afternoon": [{"id": "1003C-P1", "title": "Train to Osaka; coffee + cake", "tags": ["train", "cafe"]}], "Evening": [{"id": "1003C-E1", "title": "Ura-Namba back-alley bars", "tags": ["izakaya", "bar"]}]}}]},
        {"date": "2025-10-04", "city": "Osaka", "paths": [{"id": "A", "name": "Comfort-food loop", "slots": {"Morning": [{"id": "1004A-M1", "title": "Kuromon Market feast", "tags": ["market", "food"]}], "Afternoon": [{"id": "1004A-P1", "title": "Shinsekai + Tsutenkaku", "tags": ["retro", "view"]}, {"id": "1004A-P2", "title": "Kushikatsu (no double-dip!)", "tags": ["streetfood"]}], "Evening": [{"id": "1004A-E1", "title": "Dotonbori river cruise ‚Üí Ura-Namba bars", "tags": ["nightlife"]}]}}, {"id": "B", "name": "Kobe day trip", "slots": {"Morning": [{"id": "1004B-M1", "title": "Nunobiki Ropeway & Herb Gardens", "tags": ["view", "garden"]}], "Afternoon": [{"id": "1004B-P1", "title": "Kobe beef lunch", "tags": ["food"]}, {"id": "1004B-P2", "title": "Harborland stroll", "tags": ["harbour"]}], "Evening": [{"id": "1004B-E1", "title": "Back to Osaka; highballs", "tags": ["bar"]}]}}, {"id": "C", "name": "Himeji deep dive", "slots": {"Morning": [{"id": "1004C-M1", "title": "Himeji Castle + Koko-en", "tags": ["castle", "garden"]}], "Afternoon": [{"id": "1004C-P1", "title": "Late lunch & ramble", "tags": ["food"]}], "Evening": [{"id": "1004C-E1", "title": "Okonomiyaki supper", "tags": ["food"]}]}}, {"id": "D", "name": "USJ Halloween", "slots": {"Morning": [{"id": "1004D-M1", "title": "Universal Studios Japan", "tags": ["themepark"]}], "Afternoon": [{"id": "1004D-P1", "title": "Halloween snacks + photos", "tags": ["food", "photo"]}], "Evening": [{"id": "1004D-E1", "title": "Feast back in Namba", "tags": ["food"]}]}}]},
        {"date": "2025-10-05", "city": "Osaka", "canon": "Canon transfer: Osaka ‚Üí Tokyo", "paths": [{"id": "A", "name": "Standard move", "slots": {"Morning": [{"id": "1005A-M1", "title": "Easy start; station bento", "tags": ["food", "logistics"]}], "Afternoon": [{"id": "1005A-P1", "title": "Shinkansen back to Tokyo", "tags": ["train"]}, {"id": "1005A-P2", "title": "Check-in", "tags": ["logistics"]}], "Evening": [{"id": "1005A-E1", "title": "Kawagoe (‚ÄòLittle Edo‚Äô) stroll (optional)", "tags": ["daytrip", "oldtown"]}]}}]},
        {"date": "2025-10-06", "city": "Tokyo", "paths": [{"id": "A", "name": "Guided Fuji loop", "slots": {"Morning": [{"id": "1006A-M1", "title": "Coach to Fuji area", "tags": ["coach"]}], "Afternoon": [{"id": "1006A-P1", "title": "Lake Kawaguchi viewpoints", "tags": ["lake", "view"]}, {"id": "1006A-P2", "title": "Chureito Pagoda + ropeway", "tags": ["view"]}], "Evening": [{"id": "1006A-E1", "title": "H≈çt≈ç noodles", "tags": ["food"]}]}}, {"id": "B", "name": "DIY Kawaguchiko", "slots": {"Morning": [{"id": "1006B-M1", "title": "Highway bus from Shinjuku", "tags": ["bus"]}], "Afternoon": [{"id": "1006B-P1", "title": "Bike lakeshore; Oishi Park", "tags": ["bike", "park"]}, {"id": "1006B-P2", "title": "Ropeway if clear", "tags": ["view"]}], "Evening": [{"id": "1006B-E1", "title": "Return to Tokyo", "tags": ["bus"]}]}}, {"id": "C", "name": "Fuji‚ÄëQ Highland", "slots": {"Morning": [{"id": "1006C-M1", "title": "Rollercoasters + Fuji backdrops", "tags": ["themepark"]}], "Afternoon": [{"id": "1006C-P1", "title": "Snack through the park", "tags": ["food"]}], "Evening": [{"id": "1006C-E1", "title": "Back to Tokyo; ramen", "tags": ["food"]}]}}]},
        {"date": "2025-10-07", "city": "Tokyo", "paths": [{"id": "A", "name": "Hakone classic loop", "slots": {"Morning": [{"id": "1007A-M1", "title": "Romancecar to Hakone‚ÄëYumoto", "tags": ["train"]}], "Afternoon": [{"id": "1007A-P1", "title": "Lake Ashi pirate ship", "tags": ["boat"]}, {"id": "1007A-P2", "title": "Ropeway to ≈åwakudani (black eggs!)", "tags": ["geo"]}], "Evening": [{"id": "1007A-E1", "title": "Hakone Open‚ÄëAir Museum ‚Üí back", "tags": ["art"]}]}}, {"id": "B", "name": "Onsen + shrine focus", "slots": {"Morning": [{"id": "1007B-M1", "title": "Onsen soak", "tags": ["onsen", "relax"]}], "Afternoon": [{"id": "1007B-P1", "title": "Hakone Shrine lakeside torii", "tags": ["shrine"]}], "Evening": [{"id": "1007B-E1", "title": "Caf√© with Fuji peeks; return", "tags": ["cafe"]}]}}, {"id": "C", "name": "Outlets + views", "slots": {"Morning": [{"id": "1007C-M1", "title": "≈åwakudani ropeway", "tags": ["geo"]}], "Afternoon": [{"id": "1007C-P1", "title": "Gotemba Premium Outlets", "tags": ["shopping"]}], "Evening": [{"id": "1007C-E1", "title": "Back to Tokyo dinner", "tags": ["food"]}]}}]},
        {"date": "2025-10-08", "city": "Tokyo", "paths": [{"id": "A", "name": "Pop + teamLab", "slots": {"Morning": [{"id": "1008A-M1", "title": "Akihabara wander", "tags": ["pop"]}], "Afternoon": [{"id": "1008A-P1", "title": "teamLab (Borderless or Planets)", "tags": ["immersive"]}], "Evening": [{"id": "1008A-E1", "title": "Rooftop crawl: Shibuya Sky ‚Üí Andaz", "tags": ["rooftop"]}]}}, {"id": "B", "name": "Gourmet Tokyo", "slots": {"Morning": [{"id": "1008B-M1", "title": "Toyosu observation decks + sushi", "tags": ["market", "food"]}], "Afternoon": [{"id": "1008B-P1", "title": "Knife/depachika gifts", "tags": ["shopping", "foodhall"]}], "Evening": [{"id": "1008B-E1", "title": "High‚Äëend omakase", "tags": ["food", "omakase"]}]}}, {"id": "C", "name": "Gardens + lanes", "slots": {"Morning": [{"id": "1008C-M1", "title": "Daikanyama ‚Üí Nakameguro", "tags": ["neighbourhood"]}], "Afternoon": [{"id": "1008C-P1", "title": "Hamarikyu or Shinjuku Gyoen", "tags": ["garden"]}], "Evening": [{"id": "1008C-E1", "title": "Omoide Yokocho ‚Üí Golden Gai", "tags": ["nightlife"]}]}}]},
        {"date": "2025-10-09", "city": "Tokyo", "canon": "Canon transfer: early flight to HKG", "paths": [{"id": "A", "name": "HK welcome", "slots": {"Morning": [{"id": "1009A-M1", "title": "Fly to HKG; Airport Express", "tags": ["plane", "train"]}], "Afternoon": [{"id": "1009A-P1", "title": "Peak Tram ‚Üí Victoria Peak", "tags": ["view"]}, {"id": "1009A-P2", "title": "Mid‚ÄëLevels Escalators; Graham St art; Man Mo Temple", "tags": ["walk", "temple"]}], "Evening": [{"id": "1009A-E1", "title": "Symphony of Lights; cha chaan teng", "tags": ["harbour", "food"]}]}}]},
        {"date": "2025-10-10", "city": "Hong Kong", "paths": [{"id": "A", "name": "Lantau big views", "slots": {"Morning": [{"id": "1010A-M1", "title": "Ngong Ping 360 cable car", "tags": ["cablecar"]}], "Afternoon": [{"id": "1010A-P1", "title": "Big Buddha + Po Lin Monastery", "tags": ["temple"]}, {"id": "1010A-P2", "title": "Tai O stilt village seafood", "tags": ["food", "village"]}], "Evening": [{"id": "1010A-E1", "title": "Temple St Night Market ‚Üí Tim Ho Wan", "tags": ["market", "dim sum"]}]}}, {"id": "B", "name": "Kowloon culture loop", "slots": {"Morning": [{"id": "1010B-M1", "title": "Wong Tai Sin Temple", "tags": ["temple"]}], "Afternoon": [{"id": "1010B-P1", "title": "Nan Lian Garden; museum option", "tags": ["garden", "museum"]}], "Evening": [{"id": "1010B-E1", "title": "Rooftop: Skye or Sugar", "tags": ["rooftop", "bar"]}]}}, {"id": "C", "name": "Island chill", "slots": {"Morning": [{"id": "1010C-M1", "title": "Ferry to Lamma Island", "tags": ["ferry"]}], "Afternoon": [{"id": "1010C-P1", "title": "Easy trail + beach/seafood", "tags": ["walk", "food"]}], "Evening": [{"id": "1010C-E1", "title": "Mak‚Äôs wonton + Tai Cheong egg tarts", "tags": ["food"]}]}}]},
        {"date": "2025-10-11", "city": "Hong Kong", "canon": "Canon: late-night departure", "paths": [{"id": "A", "name": "Central wind‚Äëdown", "slots": {"Morning": [{"id": "1011A-M1", "title": "SoHo street art; PMQ design", "tags": ["art", "shopping"]}], "Afternoon": [{"id": "1011A-P1", "title": "Causeway Bay shopping", "tags": ["shopping"]}], "Evening": [{"id": "1011A-E1", "title": "Popinjays or OZONE ‚Üí Airport Express", "tags": ["rooftop", "bar"]}]}}, {"id": "B", "name": "Kowloon flavors", "slots": {"Morning": [{"id": "1011B-M1", "title": "Mong Kok markets", "tags": ["market"]}], "Afternoon": [{"id": "1011B-P1", "title": "TST promenade / museums", "tags": ["harbour", "museum"]}], "Evening": [{"id": "1011B-E1", "title": "Sugar or Skye; airport run", "tags": ["rooftop"]}]}}, {"id": "C", "name": "Dim sum + spa", "slots": {"Morning": [{"id": "1011C-M1", "title": "Dim sum brunch", "tags": ["food", "dim sum"]}], "Afternoon": [{"id": "1011C-P1", "title": "Spa & coffee crawl", "tags": ["relax", "cafe"]}], "Evening": [{"id": "1011C-E1", "title": "Harbour cruise + egg tarts ‚Üí airport", "tags": ["harbour", "food"]}]}}]}
    ],
    citySections: {
        "Tokyo": {
            intro: `Tokyo, a city of exhilarating contrasts, serves as a captivating introduction to Japan. This initial segment of the journey is designed for a dynamic exploration, balancing iconic modern landmarks with unique cultural experiences. The timing of the visit in late September offers a unique advantage, as it directly overlaps with the tail end of the Tokyo Festival and potentially other local events like the Nezu-jinja Shrine Festival and the Chofu Autumn Fireworks. This presents immediate opportunities for cultural immersion and distinctive experiences right from arrival, although it also necessitates checking specific event dates and being prepared for larger gatherings.`,
            culinary: {
                intro: `Tokyo's culinary scene is characterized by innovation and modern trends. Beyond traditional dishes, the focus is on cutting-edge or specialized culinary arts.`,
                highlights: [
                    `<strong>Sushi & Seafood:</strong> Experience unparalleled freshness at Tsukiji Outer Market or Toyosu Wholesale Fish Market. For a curated, high-end sushi journey, an Omakase experience is highly recommended.`,
                    `<strong>Ramen:</strong> Explore the diverse regional ramen styles that converge in Tokyo, perhaps at Tokyo Station's renowned Ramen Street.`,
                    `<strong>Wagyu:</strong> Indulge in premium Wagyu beef, either through a dedicated Wagyu tasting tour or a Wagyu Yakiniku dinner, offering a focused and elevated dining experience.`,
                    `<strong>Traditional Sweets (Wagashi):</strong> Discover the delicate artistry of Wagashi by participating in a hands-on class, learning to craft these beautiful confections.`,
                    `<strong>Depachika:</strong> Explore gourmet food halls located in department store basements, which offer an incredible array of Japanese and international delicacies, perfect for high-end culinary souvenirs or diverse meal assembly.`,
                    `<strong>Izakaya Culture:</strong> Experience the lively atmosphere of casual Japanese pubs, where locals gather to enjoy drinks and small plates.`,
                    `<strong>Rooftop Bars:</strong> Enjoy panoramic city views with a drink at stylish rooftop bars like Shibuya Sky (observation deck with bar), The Roof at Shibuya Stream, or the Garden Lounge at Cerulean Tower Tokyu Hotel.`
                ]
            },
            cultural: {
                intro: `Tokyo offers a rich tapestry of cultural experiences, from ancient traditions to modern pop culture.`,
                highlights: [
                    `<strong>Hands-On Experiences:</strong> Sushi Making Class, Wagashi Confection Making, Taiko Drumming Experience, Japanese Tea Ceremony, Samurai Experience, Furin Crafting, Origami Masterclass, Calligraphy Classes.`,
                    `<strong>Festivals & Events:</strong> Tokyo Festival (Ikebukuro), Nezu-jinja Shrine Annual Grand Festival, Fukuro Matsuri (Ikebeburo), Shinagawa Shukuba-matsuri Festival, Chofu Autumn Fireworks.`,
                    `<strong>Exploring Local Neighborhoods:</strong> Monzen Nakacho & Fukagawa, Yanaka Ginza & Togoshi Ginza.`
                ]
            }
        },
        "Kyoto": {
            intro: `Kyoto, the ancient capital, is a city steeped in history, renowned for its serene temples, traditional gardens, and refined culinary traditions. This two-day immersion will guide travelers through Japan's spiritual and aesthetic heart. While Kyoto is celebrated for its tranquil temples, its popularity means that many prominent sites like Kinkakuji, Ginkaku-ji, and Kiyomizudera are predictably crowded. Therefore, a key strategy involves visiting popular sites during early morning or late afternoon hours to mitigate crowds, and interspersing these with visits to less-frequented temples or off-the-beaten-path locations to achieve a balanced and more contemplative experience.`,
            culinary: {
                intro: `Kyoto's food culture is distinctively refined, emphasizing elegant dishes rooted in centuries-old historical traditions.`,
                highlights: [
                    `<strong>Kaiseki Ryori:</strong> This multi-course meal represents the pinnacle of Kyoto's dining, featuring masterfully prepared seasonal ingredients that are as visually stunning as they are delicious.`,
                    `<strong>Shojin Ryori:</strong> Experience traditional vegetarian Buddhist monk's cuisine, often enjoyed in the serene settings of temples, emphasizing simple yet profound flavors.`,
                    `<strong>Obanzai Ryori:</strong> Savor Kyoto's traditional home-style cooking, characterized by multiple small, comforting dishes.`,
                    `<strong>Nishiki Market:</strong> Known as "Kyoto's Kitchen," this vibrant market offers a vast array of local produce, regional specialties, and street food, perfect for a culinary exploration.`,
                    `<strong>Sake Tasting:</strong> Explore the Fushimi Sake District, an area celebrated for its breweries and offering diverse sake tasting experiences.`
                ]
            },
            cultural: {
                intro: `Kyoto offers a deep dive into traditional Japanese arts, crafts, and spiritual practices.`,
                highlights: [
                    `<strong>Hands-On Experiences:</strong> Japanese Tea Ceremony, Soba Noodle Masterclass.`,
                    `<strong>Festivals & Events:</strong> Jidai Matsuri (Historical parade), Kurama Fire Festival (Traditional fire festival), Otsukimi (Moon Viewing Festivals).`,
                    `<strong>Traditional Arts & Crafts:</strong> Seek out shops specializing in pottery, textiles, and woodblock prints.`
                ]
            }
        },
        "Osaka": {
            intro: `Osaka, often hailed as the "Kitchen of Japan," offers a vibrant, laid-back atmosphere and a distinct comfort food culture. This two-day segment of the journey will be a feast for the senses, focusing on street food, quirky neighborhoods, and unique dining experiences. Osaka's culinary scene is explicitly characterized by its "comfort food" and "laid-back atmosphere." This implies a distinct dining philosophy compared to Tokyo's innovation or Kyoto's refinement, encouraging a more casual and spontaneous approach to eating. Furthermore, beyond just Dotonbori, Osaka boasts several distinct "quirky neighborhoods," each with its own unique character and culinary focus, suggesting that a deeper exploration of Osaka involves thematic neighborhood visits rather than merely central landmarks.`,
            culinary: {
                intro: `Osaka's culinary scene is explicitly characterized by "comfort food" and a "laid-back atmosphere," encouraging a more casual and spontaneous approach to eating.`,
                highlights: [
                    `<strong>Takoyaki:</strong> These fried octopus balls are a ubiquitous and beloved street snack, representing the heart of Osaka's casual dining.`,
                    `<strong>Okonomiyaki:</strong> Enjoy these savory pancakes, a highly customizable and hearty dish that embodies Osaka's approachable food culture.`,
                    `<strong>Kushikatsu:</strong> Deep-fried skewers of various ingredients offer a popular and versatile comfort food experience.`,
                    `<strong>Kuromon Market:</strong> Referred to as "Osaka's Kitchen," this vibrant market is a prime destination for fresh seafood and local delicacies, including Fugu sashimi.`,
                    `<strong>Unique Dining:</strong> For an interactive and memorable experience, consider catching and eating your own fish at Tsurikichi.`
                ]
            },
            cultural: {
                intro: `Osaka offers a unique blend of retro charm, modern entertainment, and vibrant local life.`,
                highlights: [
                    `<strong>Hands-On Experiences:</strong> Osaka Cooking Class (Takoyaki/Okonomiyaki).`,
                    `<strong>Festivals & Events:</strong> Kishiwada Danjiri Matsuri, USJ Halloween.`,
                    `<strong>Exploring Local Neighborhoods:</strong> Shinsekai District, Nakazakicho, Ura Namba.`
                ]
            }
        },
        "Hong Kong": {
            intro: `Hong Kong, a vibrant fusion of East and West, offers a dynamic urban landscape, spiritual sanctuaries, and a world-renowned culinary scene. This short yet intense visit is designed to focus on its iconic sights and unforgettable flavors. Hong Kong's culinary identity is a dynamic blend of Cantonese, European (especially British), and other Asian influences. This unique fusion promises a broad and diverse gastronomic adventure, where the foodie experience extends beyond specific traditional dishes to encompass a distinctive East-meets-West gastronomic identity. Given the limited time (2.5 days) and the preference for no day trips outside the city, the itinerary strategically groups attractions geographically and thematically to minimize transit time and maximize exploration within Hong Kong's distinct areas.`,
            culinary: {
                intro: `Hong Kong cuisine is a dynamic blend of Cantonese, European (especially British), and other Asian influences, offering a broad and diverse culinary adventure.`,
                highlights: [
                    `<strong>Dim Sum:</strong> A quintessential Hong Kong experience, best enjoyed at Michelin-starred establishments like Tim Ho Wan, famous for its Baked BBQ Pork Buns and other classic dishes.`,
                    `<strong>Hong Kong-style Milk Tea & Egg Tarts:</strong> These iconic local beverages and pastries reflect the city's unique colonial history and fusion culture.`,
                    `<strong>Wonton Noodles:</strong> A classic Cantonese dish, perfected in Hong Kong and a staple of local cuisine.`,
                    `<strong>Roasted Goose/Duck:</strong> A Cantonese specialty, often found in traditional restaurants and highly prized.`,
                    `<strong>Street Food:</strong> Explore bustling night markets for a wide array of local snacks, offering a vibrant and authentic dining experience.`,
                    `<strong>Rooftop Bars:</strong> Experience stunning skyline views from high-altitude bars like Ozone (Ritz-Carlton), Aqua (Tsim Sha Tsui), or Sevva (Central).`
                ]
            },
            cultural: {
                intro: `Hong Kong offers a unique blend of spiritual sites, bustling markets, and modern urban experiences.`,
                highlights: [
                    `<strong>Hands-On Experiences:</strong> While less focused on traditional classes, the city offers unique culinary tours and market explorations.`,
                    `<strong>Festivals & Events:</strong> Check for local festivals or events happening during your stay.`,
                    `<strong>Exploring Local Neighborhoods:</strong> Tai O Fishing Village, Mong Kok, Graham Street.`
                ]
            }
        }
    },
    practicalConsiderations: {
        id: "practical-considerations",
        title: "Practical Considerations & Insider Tips for a Smooth Journey",
        intro: `Ensuring a seamless and enjoyable trip requires foresight and attention to detail, particularly given the popularity of the chosen destinations and the travel period. The combination of major tourist hubs (Tokyo, Kyoto, Osaka, Hong Kong) and the timing (late September/early October, coinciding with Japanese public holidays and festivals) creates a high likelihood of significant crowds. This is not merely a minor inconvenience but a critical factor that can impact the quality of the experience, necessitating proactive planning and strategic navigation to maximize enjoyment and minimize potential frustrations.`,
        sections: [
            { heading: "Strategic Timing for Attractions", content: `Arriving early morning or late afternoon at popular sites (Arashiyama Bamboo Grove, Fushimi Inari Taisha, Kinkakuji, Shibuya Sky) can significantly reduce crowds. Whenever feasible, visit major attractions on weekdays to avoid larger weekend crowds, especially during national public holidays.`, details: `` },
            { heading: "Booking Essentials", content: `Tickets for Ghibli Museum and Mario Kart Racing are highly sought after and must be booked well in advance. Reservations for high-end Omakase experiences or unique restaurants are highly recommended for groups. Booking Shinkansen tickets in advance is advisable, especially during holiday periods. Secure hotel bookings well in advance. **For the Sumo Grand Tournament Finals, tickets are extremely competitive and often sell out immediately upon release; securing them well in advance is critical.**`, details: `` },
            { heading: "Navigating Crowds", content: `Be prepared to adjust plans if a site is unexpectedly crowded. Utilize early mornings or late afternoons. Incorporate "off the beaten path" locations (Otagi Nenbutsu-ji in Kyoto, Nakazakicho in Osaka) to escape main tourist flows.`, details: `` },
            { heading: "Language & Communication", content: `Modern translation applications (e.g., Google Translate) are invaluable. Learning simple Japanese phrases (arigato, sumimasen, konnichiwa) and Cantonese phrases (jo san, m goi) can greatly enhance interactions.`, details: `` },
            { heading: "Safety & Local Customs", content: `Adhere to public transport etiquette (quiet carriages, no loud phone conversations, respect queues). Be aware of dining customs (no double-dipping for kushikatsu). Tipping is generally not customary in Japan or Hong Kong. Be prepared for extensive walking. Carry sufficient local currency (Japanese Yen and Hong Kong Dollars).`, details: `` }
        ]
    }
};

const allActivities = itineraryData.itineraryDays.flatMap(d =>
  d.paths.flatMap(p =>
    Object.entries(p.slots).flatMap(([slot, items]) =>
      items.map(i => ({...i, date: d.date, city: d.city, path: p.id, slot}))
    )
  )
);

let progress = {}
let selectedTabs = {}
let filters = { city: "All", tag: "All", status: "All", search: "" };

function saveProgress() { localStorage.setItem(STORAGE_KEY, JSON.stringify(progress)); }
function loadProgress() { try { progress = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch(e) { progress = {}; } }
loadProgress();

function fmtDate(iso) { return new Date(iso + "T00:00:00").toLocaleDateString(undefined, {weekday:"short", day:"2-digit", month:"short"}); }
function pct(a,b) { if(!b) return 0; return Math.round((a/b)*100); }
function el(html) { const d=document.createElement("div"); d.innerHTML = html.trim(); return d.firstChild; }
function getCities() { return ["All", ...Array.from(new Set(itineraryData.itineraryDays.map(d => d.city)))]; }
function getTags() { const s=new Set(); allActivities.forEach(a => (a.tags||[]).forEach(t=>s.add(t))); return ["All", ...Array.from(s).sort()]; }

function applyFilters(a) {
  if (filters.city !== "All" && a.city !== filters.city) return false;
  if (filters.tag !== "All" && !(a.tags||[]).includes(filters.tag)) return false;
  const q = filters.search.trim().toLowerCase();
  if (q && !(a.title + " " + a.city + " " + a.slot).toLowerCase().includes(q)) return false;
  if (filters.status === "Done" && !progress[a.id]) return false;
  if (filters.status === "Todo" && progress[a.id]) return false;
  return true;
}

function totals() {
  const per = {};
  allActivities.forEach(a=>{ const k=a.city; per[k]=per[k]||{done:0,total:0}; per[k].total++; if(progress[a.id]) per[k].done++; });
  const overallDone = Object.values(per).reduce((s,c)=>s+c.done,0);
  const overallTotal = Object.values(per).reduce((s,c)=>s+c.total,0);
  return {per, overallDone, overallTotal};
}

function renderSummary() {
  const wrap = document.getElementById("progressSummary");
  wrap.innerHTML = "";
  const t = totals();
  Object.entries(t.per).forEach(([city,v]) => {
    wrap.appendChild(el(`<div><div class="flex justify-between text-sm mb-1"><span>${city}</span><span>${v.done}/${v.total}</span></div><div class="progress"><span style="width:${pct(v.done,v.total)}%"></span></div></div>`));
  });
  wrap.appendChild(el(`<div class="pt-2"><div class="flex justify-between text-sm mb-1 font-medium"><span>Overall</span><span>${t.overallDone}/${t.overallTotal}</span></div><div class="progress"><span style="width:${pct(t.overallDone,t.overallTotal)}%"></span></div></div>`));
}

function nextUp() {
  const cand = allActivities.filter(a => !progress[a.id]).filter(applyFilters).sort((x,y)=>new Date(x.date)-new Date(y.date))[0];
  const wrap = document.getElementById("nextUpWrap");
  if(!cand) { wrap.innerHTML = ""; return; }
  wrap.innerHTML = `<div class="rounded-2xl border p-3 mb-3 card"><div class="flex items-center gap-3"><div class="text-emerald-600">üß≠</div><div class="text-sm"><div class="font-medium">Next up</div><div class="text-slate-600 dark:text-slate-400">${fmtDate(cand.date)} ¬∑ ${cand.city} ¬∑ Path ${cand.path}: <span class="font-medium">${cand.title}</span></div></div><div class="ml-auto"><button class="btn btn-primary" onclick="toggle('${cand.id}')">‚úîÔ∏è Mark done</button></div></div></div>`;
}

function toggle(id) { progress[id] = !progress[id]; saveProgress(); renderAll(); }
function markPath(date, pathId, val) { allActivities.filter(a=>a.date===date&&a.path===pathId).forEach(a=>progress[a.id]=val); saveProgress(); renderAll(); }

function createSectionDetails(section) {
    return `
        <details class="mb-4">
            <summary>${section.heading}</summary>
            <div class="p-2 text-sm text-stone-600 dark:text-stone-400">
                <p>${section.content}</p>
                ${section.details || ''}
            </div>
        </details>
    `;
}

function renderContent() {
    const contentWrap = document.getElementById("itineraryContent");
    contentWrap.innerHTML = "";

    // Pre-Trip Essentials
    contentWrap.appendChild(el(`<h2 id="${itineraryData.preTripEssentials.id}" class="section-heading"><span>${itineraryData.preTripEssentials.title}</span></h2>`));
    const preTripCard = el(`<div class="card p-6 mb-8"></div>`);
    itineraryData.preTripEssentials.sections.forEach(s => preTripCard.appendChild(el(createSectionDetails(s))));
    contentWrap.appendChild(preTripCard);

    let currentCity = null;

    itineraryData.itineraryDays.forEach(day => {
        if (day.city !== currentCity && !day.canon) { // Start of a new city section, and not just a travel day
            currentCity = day.city;
            const cityInfo = itineraryData.citySections[day.city];
            if (cityInfo) {
                contentWrap.appendChild(el(`<h2 id="${day.city.toLowerCase().replace(/\s/g, '-')}-section" class="section-heading"><span>${day.city}: ${day.date} - ${itineraryData.itineraryDays.findLast(d => d.city === day.city && !d.canon)?.date || day.date}</span></h2>`));
                const cityIntroCard = el(`<div class="card p-6 mb-8"></div>`);
                cityIntroCard.appendChild(el(`<p class="mb-6 text-stone-600 dark:text-stone-400">${cityInfo.intro}</p>`));
                cityIntroCard.appendChild(el(`
                    <details class="mb-6">
                        <summary class="text-xl">Culinary Deep Dive</summary>
                        <div class="p-2 text-sm text-stone-600 dark:text-stone-400">
                            <p class="mb-2">${cityInfo.culinary.intro}</p>
                            <ul class="list-disc list-inside ml-4">
                                ${cityInfo.culinary.highlights.map(h => `<li>${h}</li>`).join('')}
                            </ul>
                        </div>
                    </details>
                `));
                cityIntroCard.appendChild(el(`
                    <details class="mb-6">
                        <summary class="text-xl">Cultural Immersion</summary>
                        <div class="p-2 text-sm text-stone-600 dark:text-stone-400">
                            <p class="mb-2">${cityInfo.cultural.intro}</p>
                            <ul class="list-disc list-inside ml-4">
                                ${cityInfo.cultural.highlights.map(h => `<li>${h}</li>`).join('')}
                            </ul>
                        </div>
                    </details>
                `));
                contentWrap.appendChild(cityIntroCard);
            }
        }

        const card = el(`<div class="card p-4 mb-4"></div>`);
        const header = el(`<div class="pb-2 flex items-center gap-2 flex-wrap"><div class="font-semibold text-lg">üìÖ ${fmtDate(day.date)}</div><div class="text-slate-500">üìç ${day.city}</div>${day.canon?`<span class='badge badge-black'>${day.canon}</span>`:''}</div>`);
        card.appendChild(header);

        if (!day.canon) {
            if(!selectedTabs[day.date]) selectedTabs[day.date] = (day.paths[0]||{}).id || "A";
            const tabs = el(`<div class="grid grid-cols-4 gap-2 mb-3"></div>`);
            day.paths.forEach(p=>{
                const b=el(`<button class="tab-btn">${p.name.split(' ')[0]}</button>`);
                if(selectedTabs[day.date]===p.id) b.classList.add("active");
                b.onclick=()=>{selectedTabs[day.date]=p.id; renderAll();};
                tabs.appendChild(b);
            });
            card.appendChild(tabs);
        }

        day.paths.forEach(p=>{
            const vis = selectedTabs[day.date]===p.id || day.canon; // Always show content for canon events
            const items = Object.values(p.slots).flat();
            const done = items.filter(i=>progress[i.id]).length;
            const total = items.length || 1;
            const sec = el(`<div class="path-section ${vis?'':'hidden'}"></div>`);

            if (!day.canon) {
                sec.appendChild(el(`<div class="flex items-center gap-2 mb-2"><div class="text-base font-medium">${p.name}</div><div class="ml-auto text-xs text-slate-500 dark:text-slate-400">${done}/${total}</div></div>`));
                sec.appendChild(el(`<div class="progress mb-3"><span style="width:${pct(done,total)}%"></span></div>`));
            }

            const grid = el(`<div class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>`);
            Object.entries(p.slots).forEach(([slot,acts])=>{
                const col=el(`<div class="rounded-xl border p-3 bg-stone-50 dark:bg-slate-800 border-stone-200 dark:border-slate-700"></div>`);
                col.appendChild(el(`<div class="font-medium mb-2 text-stone-700 dark:text-stone-200">‚è∞ ${slot}</div>`));
                const list=el(`<div class="space-y-2"></div>`);
                acts.forEach(a=>{
                    if(!applyFilters(a)) return;
                    const checked = !!progress[a.id];
                    const row = el(`<label class="flex items-start gap-2 text-sm cursor-pointer"></label>`);
                    const cb = el(`<input type="checkbox" ${checked?'checked':''}>`);
                    cb.onchange = () => toggle(a.id);
                    const title = el(`<div class="${checked?'strike':''}">${a.title}</div>`);
                    const tags = el(`<div class="mt-1"></div>`);
                    (a.tags||[]).forEach(t=>tags.appendChild(el(`<span class="pill mr-1 mb-1 inline-block">${t}</span>`)));
                    const wrapInner = el(`<div></div>`); wrapInner.appendChild(title); wrapInner.appendChild(tags);
                    row.appendChild(cb); row.appendChild(wrapInner); list.appendChild(row);
                });
                col.appendChild(list); grid.appendChild(col);
            });
            sec.appendChild(grid);

            if (!day.canon) { // Only show path actions for non-canon days
                const actions = el(`<div class="flex items-center gap-2 mt-3"></div>`);
                const b1 = el(`<button class="btn btn-primary">‚úîÔ∏è Mark all in Path ${p.id} done</button>`);
                b1.onclick = () => markPath(day.date, p.id, true);
                const b2 = el(`<button class="btn">‚Ü∫ Reset this Path</button>`);
                b2.onclick = () => markPath(day.date, p.id, false);
                actions.appendChild(b1); actions.appendChild(b2); sec.appendChild(actions);
            }
            card.appendChild(sec);
        });
        contentWrap.appendChild(card);
    });

    // Practical Considerations
    contentWrap.appendChild(el(`<h2 id="${itineraryData.practicalConsiderations.id}" class="section-heading"><span>${itineraryData.practicalConsiderations.title}</span></h2>`));
    const practicalCard = el(`<div class="card p-6 mt-8"></div>`);
    practicalCard.appendChild(el(`<p class="mb-4 text-stone-600 dark:text-stone-400">${itineraryData.practicalConsiderations.intro}</p>`));
    itineraryData.practicalConsiderations.sections.forEach(s => practicalCard.appendChild(el(createSectionDetails(s))));
    contentWrap.appendChild(practicalCard);
}

function renderAll() {
  renderSummary();
  nextUp();
  renderContent(); // Re-render content to apply filters and path selections
  populateSidebar(); // Re-populate sidebar to ensure correct links and active state
  setupDetailsToggle(); // Re-attach listener for details transition
}

// Custom Modal Logic
const customModal = document.getElementById('customModal');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalCancel = document.getElementById('modalCancel');
const modalConfirm = document.getElementById('modalConfirm');

function showModal(title, message, isConfirm = false) {
    return new Promise((resolve) => {
        modalTitle.textContent = title;
        modalMessage.innerHTML = message;
        modalCancel.style.display = isConfirm ? 'block' : 'none'; // Show cancel only for confirm
        modalConfirm.textContent = isConfirm ? 'Confirm' : 'OK';

        customModal.classList.add('open');

        const confirmHandler = () => {
            customModal.classList.remove('open');
            modalConfirm.removeEventListener('click', confirmHandler);
            modalCancel.removeEventListener('click', cancelHandler);
            resolve(true);
        };
        const cancelHandler = () => {
            customModal.classList.remove('open');
            modalConfirm.removeEventListener('click', confirmHandler);
            modalCancel.removeEventListener('click', cancelHandler);
            resolve(false);
        };

        modalConfirm.addEventListener('click', confirmHandler);
        modalCancel.addEventListener('click', cancelHandler);
    });
}

// Smooth transition for details tags
function setupDetailsToggle() {
  document.querySelectorAll('details').forEach((details) => {
    details.addEventListener('toggle', (event) => {
      const content = details.querySelector('div');
      if (details.open) {
        content.style.maxHeight = content.scrollHeight + 'px';
      } else {
        content.style.maxHeight = '0';
      }
    });
  });
}

// Sidebar population and scrolling
function populateSidebar() {
    const sidebarNav = document.getElementById('sidebarNav');
    sidebarNav.innerHTML = `<h3 class="font-bold text-stone-800 dark:text-stone-100 text-lg mb-2">Sections</h3>`;

    const sections = [
        { id: itineraryData.preTripEssentials.id, title: "Pre-Trip Essentials" }
    ];

    let lastCity = null;
    itineraryData.itineraryDays.forEach(day => {
        if (day.city !== lastCity && !day.canon) {
            const citySectionId = `${day.city.toLowerCase().replace(/\s/g, '-')}-section`;
            const lastDayForCity = itineraryData.itineraryDays.findLast(d => d.city === day.city && !d.canon);
            const title = `${day.city} (${fmtDate(day.date)} - ${fmtDate(lastDayForCity.date)})`;
            sections.push({ id: citySectionId, title: title });
            lastCity = day.city;
        }
    });

    sections.push({ id: itineraryData.practicalConsiderations.id, title: "Practical Considerations" });

    sections.forEach(sec => {
        const link = el(`<a href="#${sec.id}">${sec.title}</a>`);
        link.onclick = (e) => {
            e.preventDefault();
            document.getElementById(sec.id).scrollIntoView({ behavior: 'smooth' });
            // Optional: Add active class to sidebar link
            sidebarNav.querySelectorAll('a').forEach(a => a.classList.remove('active'));
            link.classList.add('active');
        };
        sidebarNav.appendChild(link);
    });

    // Add scroll listener for active sidebar link
    const observerOptions = {
      root: null,
      rootMargin: '0px',
      threshold: 0.5 // Adjust as needed
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          sidebarNav.querySelectorAll('a').forEach(a => a.classList.remove('active'));
          const activeLink = sidebarNav.querySelector(`a[href="#${entry.target.id}"]`);
          if (activeLink) {
            activeLink.classList.add('active');
          }
        }
      });
    }, observerOptions);

    document.querySelectorAll('.section-heading').forEach(section => {
      observer.observe(section);
    });
}


// Controls
document.getElementById("printBtn").onclick = () => window.print();
document.getElementById("exportBtn").onclick = () => {
    const blob=new Blob([JSON.stringify(progress,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="itinerary-progress.json";
    a.click();
    URL.revokeObjectURL(url);
};
document.getElementById("importInput").onchange = async (e) => {
    const f=e.target.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload= async ()=>{
        try{
            progress=JSON.parse(r.result);
            saveProgress();
            await showModal('Import Successful', 'Your progress has been imported successfully.', false);
            renderAll();
        }catch{
            await showModal('Import Failed', 'Invalid JSON file. Please ensure the file contains valid progress data.', false);
        }
    };
    r.readAsText(f);
    e.target.value = ''; // Clear file input
};
document.getElementById("resetBtn").onclick = async () => {
    const confirmed = await showModal('Reset Progress', 'Are you sure you want to reset all your progress? This action cannot be undone.', true);
    if(confirmed) {
        progress={};
        saveProgress();
        renderAll();
    }
};

// Dark toggle
const darkToggle = document.getElementById("darkToggle");
const savedDark = localStorage.getItem("itinerary-dark") === "true";
if(savedDark) document.documentElement.classList.add("dark");
darkToggle.checked = savedDark;
darkToggle.onchange = () => { document.documentElement.classList.toggle("dark", darkToggle.checked); localStorage.setItem("itinerary-dark", darkToggle.checked ? "true" : "false"); };

// Populate filters
const citySel = document.getElementById("cityFilter");
getCities().forEach(c => citySel.appendChild(el(`<option>${c}</option>`)));
citySel.onchange = () => { filters.city = citySel.value; renderAll(); };

const tagSel = document.getElementById("tagFilter");
getTags().forEach(t => tagSel.appendChild(el(`<option>${t}</option>`)));
// BUGFIX: use tagSel.value instead of undefined variable `t`
tagSel.onchange = () => { filters.tag = tagSel.value; renderAll(); };

document.getElementById("statusFilter").onchange = (e) => { filters.status = e.target.value; renderAll(); };
document.getElementById("searchInput").oninput = (e) => { filters.search = e.target.value; renderAll(); };

renderAll();
</script>
</body>
</html>
